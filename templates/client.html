<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

  <!-- Your module MUST load before inline code runs -->
  <script type="module" src="/static/js/credchain.js"></script>

  <title>CredChain - Client Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0a0a0a;
      color: #e0e0e0;
      text-align: center;
      margin: 0;
      padding: 30px;
    }
    h1 { color: #00ffc8; margin-bottom: 10px; }
    button {
      background-color: #00ffc8;
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      margin: 8px;
      font-weight: bold;
      transition: 0.2s;
    }
    button:hover { background-color: #00cba1; }
    input {
      padding: 8px;
      margin: 5px;
      width: 250px;
      border-radius: 6px;
      border: none;
    }
    .section {
      border: 1px solid #222;
      padding: 15px;
      margin: 20px auto;
      width: 80%;
      border-radius: 12px;
      background: #121212;
    }
    .project-card {
      border: 1px solid #333;
      padding: 15px;
      margin: 15px auto;
      width: 80%;
      text-align: left;
      border-radius: 10px;
      background: #1a1a1a;
    }
    .review-form {
      margin-top: 10px;
      background: #0f0f0f;
      padding: 10px;
      border-radius: 8px;
    }
    a { color: #00ffc8; }
    .already-reviewed {
      background: #002a1f;
      color: #00ffc8;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>

<body>

  <h1>CredChain ‚Äì Client Dashboard</h1>

  <button id="connect">üîó Connect MetaMask</button>
  <div id="addr"></div>
  
  <div class="section">
  <h2>üë§ Client Profile</h2>

  <input id="cName" placeholder="Your Name"><br>
  <input id="cCompany" placeholder="Company Name"><br>
  <input id="cEmail" placeholder="Email"><br>
  <input id="cPhone" placeholder="Phone"><br>

  <button id="saveClient">Save Profile</button>

  <h3>Saved Profile:</h3>
  <div id="clientProfileBox">No data loaded.</div>
</div>


  <div class="section">
    <h2>üîç Search Freelancers by Language</h2>
    <input id="searchLang" placeholder="ex: python, react, rust" />
    <button id="searchBtn">Search</button>
    <div id="searchResults"></div>
  </div>


  <h3>Verify Identity (LinkedIn)</h3>
  <input id="profileLink" placeholder="https://linkedin.com/in/..."/>
  <button id="verify">Verify</button>

  <button id="loadClientProjects">View My Project</button>

  <div class="section">
    <h2>üìÅ My Assigned Projects + Reviews</h2>
    <div id="projects">Connect wallet to load your projects...</div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", async () => {

    // wait for credchain.js module to register window functions
    await new Promise(r => setTimeout(r, 300));

    let account;

  //-----------------------------------------------------------CREATE CLIENT PROFILE-----------------------------------------------------------
    document.getElementById("saveClient").onclick = async () => {
        if (!account) {
            alert("Connect wallet first!");
            return;
        }

        const name = document.getElementById("cName").value;
        const company = document.getElementById("cCompany").value;
        const email = document.getElementById("cEmail").value;
        const phone = document.getElementById("cPhone").value;

        const res = await fetch("http://localhost:5000/save_client_profile", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                wallet: account,
                name, company, email, phone
            })
        });

        const data = await res.json();

        if (data.success) {
            alert("Client profile saved!");
            loadClientProfile();
        }
    };
    
  //-----------------------------------------------------------LOAD CLIENT PROFILE-----------------------------------------------------------
    async function loadClientProfile() {
      if (!account) return;

      const res = await fetch(`http://localhost:5000/get_client_profile/${account}`);
      const data = await res.json();

      const box = document.getElementById("clientProfileBox");

      if (!data.exists) {
          box.innerHTML = "No profile found.";
          return;
      }

      const p = data.profile;

      box.innerHTML = `
        <b>Name:</b> ${p.name || "-"}<br>
        <b>Company:</b> ${p.company || "-"}<br>
        <b>Email:</b> ${p.email || "-"}<br>
        <b>Phone:</b> ${p.phone || "-"}<br>
      `;
  }

  //-----------------------------------------------------------CONNECT-----------------------------------------------------------
    document.getElementById("connect").onclick = async () => {
        try {
            const addr = await window.connectWallet();  // from credchain.js
            account = addr;
            document.getElementById("addr").innerText = "Connected: " + addr;
            loadClientProfile();
        } catch (e) {
            alert("Connection failed: " + e.message);
        }
    };

  //-----------------------------------------------------------VERIFICATION-----------------------------------------------------------
    document.getElementById("verify").onclick = async () => {
        const link = document.getElementById("profileLink").value;

        const backendRes = await fetch("http://localhost:5000/verifyuser", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({wallet: account, profile_link: link})
        });

        const backendData = await backendRes.json();

        if (!backendData.valid) {
            alert("Validation failed: " + backendData.reason);
            return;
        }

        const { wallet, tx } = await window.verifyUserOnChain();
        alert("Verified On Chain!\nWallet: " + wallet + "\nTx: " + tx.transactionHash);
    };

  //-----------------------------------------------------------LOAD PROJECTS+REVIEWS-----------------------------------------------------------
    async function loadClientProjects() {
        if (!account) {
          alert("Connect wallet first!");
          return;
        }
        document.getElementById("projects").innerText = "Fetching your projects...";

        // üî• Load projects from blockchain
        const projectsData = await window.getProjectsForClient(account);

        if (!projectsData || projectsData.length === 0) {
            document.getElementById("projects").innerText = "No projects found for this client wallet.";
            return;
        }

        let html = "";
        let projectCount = 0;

        for (const [index, proj] of projectsData.entries()) {
            const builder = proj.freelancer;
            const idx = proj.index ?? index;

            // üî• Get reviews from blockchain
            const detailReviews = await window.getProjectReviewsFromChain(builder, idx);

            projectCount++;

            const hasReviewed = detailReviews.some(
                r => r.reviewer.toLowerCase() === account.toLowerCase()
            );

            html += `
            <div class="project-card">
                <h3>Project #${projectCount}</h3>

                <b>Builder:</b> ${builder}<br>
                <b>Description:</b> ${proj.description}<br>
                <b>Languages:</b> ${proj.languages}<br>
                <b>Link:</b> <a href="${proj.link}" target="_blank">${proj.link}</a><br>
                <b>Hash:</b> ${proj.projectHash}<br>
                <hr>

                <b>Reviews:</b>
                <pre>
                ${detailReviews.length > 0 ?
                detailReviews.map(r => 
                `‚≠ê Rating: ${r.rating}
                üîó Comment: ${r.commentHash}`
                ).join("\n\n")
                : "No reviews yet."}
                            </pre>
                        `;

            // review form
            if (!hasReviewed) {
                html += `
                <div class="review-form">
                    <h4>Leave a Review</h4>
                    <input id="rating-${builder}-${idx}" type="number" min="1" max="5" placeholder="Rating 1-5">
                    <input id="comment-${builder}-${idx}" placeholder="Comment Hash">
                    <button onclick="submitReview('${builder}', ${idx})">Submit Review</button>
                </div>`;
            } else {
                html += `<div class="already-reviewed">‚úî You already reviewed this project</div>`;
            }

            html += `</div>`;
        }

        document.getElementById("projects").innerHTML = html;
    }

    document.getElementById("loadClientProjects").onclick = loadClientProjects;


  //-----------------------------------------------------------SUBMIT REVIEWS-----------------------------------------------------------
    window.submitReview = async (freelancer, projectIndex) => {
        const rating = parseInt(document.getElementById(`rating-${freelancer}-${projectIndex}`).value);
        const comment_hash = document.getElementById(`comment-${freelancer}-${projectIndex}`).value.trim();

        if (isNaN(rating)) return alert("Enter valid rating");

        const tx = await window.submitReviewOnChain(freelancer,projectIndex,rating,comment_hash);

        const data = await res.json();
        if (data.error) alert("‚ùå " + data.error);
        else alert("Review submitted!\nTX: " + data.tx);

        loadClientProjects();
    };

    //----------------------------------------------------------SEARCHING----------------------------------------------------------
    document.getElementById("searchBtn").onclick = async () => {
    const q = document.getElementById("searchInput").value.trim().toLowerCase();

    if (!q) {
        document.getElementById("searchResults").innerHTML = "<p>Please enter a language.</p>";
        return;
    }

    const res = await fetch(`http://localhost:5000/search_freelancers/${q}`);
    const data = await res.json();

    if (!data.length) {
        document.getElementById("searchResults").innerHTML = 
            `<p style="color:red;">No freelancers found for "${q}"</p>`;
        return;
    }

    let html = "";
    data.forEach((f, idx) => {
      html += `
          <div class="project-card">
              <h3>Freelancer #${idx + 1}</h3>
              
              <b>Name:</b> ${f.name || "Unnamed"}<br>
              <b>Wallet:</b> ${f.wallet}<br>
              <b>Bio:</b> ${f.bio || "No bio"}<br>
              <b>Skills:</b> ${f.skills?.join(", ") || "Not listed"}<br>

              <b>GitHub:</b> ${
                  f.github 
                  ? `<a href="${f.github}" target="_blank">${f.github}</a>` 
                  : "Not linked"
              }<br>

              <b>LinkedIn:</b> ${
                  f.linkedin 
                  ? `<a href="${f.linkedin}" target="_blank">${f.linkedin}</a>` 
                  : "Not linked"
              }<br>
          </div>
      `;
  });


      document.getElementById("searchResults").innerHTML = html;
  };



document.getElementById("searchBtn").onclick = async () => {
    const lang = document.getElementById("searchLang").value.toLowerCase();
    window.searchFreelancers(lang);   // call JS function in credchain.js
};

});
</script>

</body>
</html>
