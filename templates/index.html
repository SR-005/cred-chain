<!doctype html>
<html>
<head>
  <meta charset="utf-8">

  <!-- Web3 + Contract JS -->
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <link rel="icon" href="/static/favicon.ico">

  <script type="module" src="/static/js/credchain.js"></script>


  <title>CredChain ‚Äì Freelancer Dashboard</title>

  <style>
    body { font-family: Arial; background:#0a0a0a; color:#e0e0e0; text-align:center; padding:30px; }
    h2, h3 { color:#00ffc8; }
    button { background:#00ffc8; padding:10px 20px; border-radius:8px; border:none; cursor:pointer; margin:10px; }
    button:hover { background:#00cba1; }
    input, textarea { background:#111; border:none; color:#e0e0e0; border-radius:6px; width:300px; margin:5px; padding:8px; }
    textarea { width:400px; height:80px; }
    .section { background:#121212; border-radius:12px; padding:20px; margin:30px auto; width:80%; }
    .project-card { background:#1a1a1a; margin:20px auto; padding:15px; border-radius:10px; width:80%; text-align:left; }
  </style>
</head>

<body>

<h2>CredChain ‚Äì Freelancer Dashboard</h2>
<button id="connect">üîó Connect MetaMask</button>
<div id="addr"></div>

<!-- PROFILE SECTION -->
<div class="section">
  <h3>üßë‚Äçüíª My Profile</h3>

  <input id="name" placeholder="Full Name"><br>
  <textarea id="bio" placeholder="Short Bio"></textarea><br>
  <input id="skills" placeholder="Skills (comma-separated)"><br>
  <input id="linkedin" placeholder="LinkedIn URL"><br>
  <input id="email" placeholder="Email Address"><br>
  <input id="phone" placeholder="Phone Number"><br>

  <button id="saveProfile">Save / Update Profile</button>
  <button id="loadProfile">View My Profile</button>

  <div id="profileDisplay"></div>
</div>

<hr>

<h3>Verify Identity (GitHub)</h3>
<input id="profileLink" placeholder="https://github.com/username"/>
<button id="verify">Verify</button>

<hr>

<h3>Submit Project</h3>
<input id="proj_name" placeholder="Project Name"/><br>
<textarea id="proj_desc" placeholder="Short Description"></textarea><br>
<input id="proj_lang" placeholder="Languages"/><br>
<input id="proj" placeholder="https://raw.githubusercontent.com/..."/><br>
<input id="client" placeholder="0xClientWalletAddress"/><br>
<button id="submit">Submit Project</button>


<script>
let account;

//----------------------------------------------------------CONNECT WALLET: WORKS----------------------------------------------------------
document.getElementById("connect").onclick = async () => 
{
    try {
        const addr = await window.connectWallet();
        account = addr;   // ‚úÖ FIX ‚Äî store wallet for later use
        document.getElementById("addr").innerText = "Connected: " + addr;
    } 
    catch (e) 
    {
        console.error("connect error:", e);
        alert("Connection failed: " + e.message);
    }
};

//----------------------------------------------------------VERIFY USER: WORKS----------------------------------------------------------
document.getElementById("verify").onclick = async () => 
{
    const link = document.getElementById("profileLink").value;
    const backendRes = await fetch("http://localhost:5000/verifyuser", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({wallet: account,  profile_link: link})
    });

    const backendData = await backendRes.json();

    if (!backendData.valid) 
    {
        alert("GitHub validation failed: " + backendData.reason);
        return;
    }

    const { wallet, tx } = await window.verifyUserOnChain();
    console.log("Verified wallet:", wallet);
    alert("Verified On Chain!\nWallet: " + wallet + "\nTx: " + tx.transactionHash);
};


//----------------------------------------------------------LOAD PROFILE: WORKS----------------------------------------------------------
async function loadProfile() {
    const box = document.getElementById("profileDisplay");
    box.innerHTML = "<p>Loading‚Ä¶</p>";

    // 1. Load off-chain profile
    const profile = await fetch(`http://localhost:5000/get_profile/${account}`);
    const pdata = await profile.json();

    let html = `
      <h3>${pdata.name || "Unnamed"}</h3>
      <p>${pdata.bio || ""}</p>
      <p><b>Skills:</b> ${(pdata.skills || []).join(", ")}</p>
      <p><b>Email:</b> ${pdata.email || "-"}</p>
      <p><b>Phone:</b> ${pdata.phone || "-"}</p>
      <hr>
      <h3>üìÅ Projects</h3>
    `;

    // 2. Load blockchain projects
    const projects = await window.getAllProjectsFromChain(account);

    if (projects.length > 0) {
        for (let i = 0; i < projects.length; i++) {
            const p = projects[i];

            // 3. Load reviews for this project
            const reviews = await window.getProjectReviewsFromChain(account, i);

            let reviewHTML = "";
            if (reviews.length > 0) {
                reviewHTML = reviews
                    .map(
                        r => `
                        ‚≠ê Rating: ${r.rating}<br>
                        üí¨ Comment: ${r.commentHash}<br>
                        üë§ Reviewer: ${r.reviewer}<br><br>
                    `
                    )
                    .join("");
            } else {
                reviewHTML = "No reviews yet.";
            }

            // 4. Append project + reviews to UI
            html += `
              <div class="project-card">
                <b>Project #${i + 1}</b><br>
                <b>Name:</b> ${p.projectName}<br>
                <b>Description:</b> ${p.description}<br>
                <b>Languages:</b> ${p.languages}<br>
                <b>Link:</b> <a href="${p.link}" target="_blank">${p.link}</a><br>
                <b>Verified:</b> ${p.verified ? "Yes" : "No"}<br>
                <b>Hash:</b> ${p.projectHash}<br>
                
                <hr>
                <b>Reviews:</b><br>
                <div class="reviews-box">
                    ${reviewHTML}
                </div>
              </div>
            `;
        }
    } else {
        html += "<p>No projects yet.</p>";
    }

    box.innerHTML = html;
}

document.getElementById("loadProfile").onclick = loadProfile;



//----------------------------------------------------------SAVE PROFILE: WORKS----------------------------------------------------------
document.getElementById("saveProfile").onclick = async () => {
    const body = {
        wallet: account,
        name: document.getElementById("name").value,
        bio: document.getElementById("bio").value,
        skills: document.getElementById("skills").value.split(",").map(s => s.trim()),
        linkedin: document.getElementById("linkedin").value,
        email: document.getElementById("email").value,
        phone: document.getElementById("phone").value
    };

    const res = await fetch("http://localhost:5000/create_profile", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(body)
    });

    alert("Profile Saved");
    loadProfile();
};


//----------------------------------------------------------ADD PROJECT: WORKS----------------------------------------------------------
document.getElementById("submit").onclick = async () => {
    const name = document.getElementById("proj_name").value;
    const desc = document.getElementById("proj_desc").value;
    const lang = document.getElementById("proj_lang").value;
    const link = document.getElementById("proj").value;
    const client = document.getElementById("client").value;

    // Backend fetches file and hashes it
    const r = await fetch("http://localhost:5000/hash_project", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({link,account})
    });
    const { hash } = await r.json();

    const tx = await addProjectOnChain(client, name, desc, lang, hash, link);
    alert("Project Added: " + tx.transactionHash);

    loadProfile();
};
</script>

</body>
</html>
